
// delivery.js

const vehicles = [
  { name: "а/м до 1т", maxWeight: 1000, loadingTypes: ["верхняя", "боковая", "любая"], surcharge: {верхняя: 1500, боковая: 1500}, minTariff: 4000, perKm: 100 },
  { name: "а/м до 1.5т", maxWeight: 1500, loadingTypes: ["верхняя", "боковая", "любая"], surcharge: {верхняя: 1500, боковая: 1500}, minTariff: 4000, perKm: 100 },
  { name: "а/м до 3т", maxWeight: 3000, loadingTypes: ["верхняя", "боковая", "любая"], surcharge: {верхняя: 1500, боковая: 1500}, minTariff: 4500, perKm: 115 },
  { name: "а/м 5т", maxWeight: 5000, loadingTypes: ["верхняя", "боковая", "любая"], surcharge: {верхняя: 2500, боковая: 2000}, minTariff: 5000, perKm: 144 },
  { name: "а/м 5т гидролифт", maxWeight: 5000, loadingTypes: ["гидролифт"], surcharge: {гидролифт: 2000}, minTariff: 6000, perKm: 154 },
  { name: "а/м 10т", maxWeight: 10000, loadingTypes: ["верхняя", "боковая", "любая"], surcharge: {верхняя: 3000, боковая: 2500}, minTariff: 8000, perKm: 210 },
  { name: "Еврофура 20т", maxWeight: 20000, loadingTypes: ["верхняя", "боковая", "любая"], surcharge: {верхняя: 3500, боковая: 3000}, minTariff: 10000, perKm: 250 },
  { name: "Манипулятор 5т", maxWeight: 5000, loadingTypes: ["manipulator"], surcharge: {manipulator: 0}, minTariff: 15000, perKm: 240 },
  { name: "Манипулятор 10т", maxWeight: 10000, loadingTypes: ["manipulator"], surcharge: {manipulator: 0}, minTariff: 20000, perKm: 240 },
  { name: "Манипулятор 15т", maxWeight: 15000, loadingTypes: ["manipulator"], surcharge: {manipulator: 0}, minTariff: 25000, perKm: 240 }
];

function selectVehicle(weight, loadingType) {
  return vehicles.find(v => v.maxWeight >= weight && v.loadingTypes.includes(loadingType));
}

function calculateMoversCost(data) {
  if (!data.need_movers) return { cost: 0, details: "" };

  const floor = parseInt(data.floor || 1);
  const lift = data.lift === "true";
  const onlyUnload = data.only_unload === "true";

  let totalCost = 0;
  let details = "<h4>Грузчики</h4>";

  const largeWeight = +data.weight_large || 0;
  const standardWeight = +data.weight_standard || 0;

  const largeFormat = data.large_format || "";
  const liftFormats = ["100x200", "100x260", "100x280"];
  const canLift = lift && liftFormats.includes(largeFormat);

  // Крупный формат
  if (largeWeight > 0) {
    if (onlyUnload) {
      totalCost += largeWeight * 20;
      details += `<p>Крупный формат: только выгрузка: ${largeWeight} кг × 20 ₽ = ${largeWeight * 20} ₽</p>`;
    } else {
      if (canLift) {
        totalCost += largeWeight * 30;
        details += `<p>Крупный формат: выгрузка и подъём (лифт): ${largeWeight} кг × 30 ₽ = ${largeWeight * 30} ₽</p>`;
      } else {
        let rate = floor <= 5 ? 50 : floor <= 10 ? 60 : floor <= 20 ? 70 : 90;
        totalCost += largeWeight * rate;
        details += `<p>Крупный формат: выгрузка и подъём (этаж ${floor}): ${largeWeight} кг × ${rate} ₽ = ${largeWeight * rate} ₽</p>`;
      }
    }
  }

  // Стандартный формат
  if (standardWeight > 0) {
    if (onlyUnload) {
      totalCost += standardWeight * 7;
      details += `<p>Обычный формат: только выгрузка: ${standardWeight} кг × 7 ₽ = ${standardWeight * 7} ₽</p>`;
    } else {
      if (lift) {
        totalCost += standardWeight * 9;
        details += `<p>Обычный формат: выгрузка и подъём (лифт): ${standardWeight} кг × 9 ₽ = ${standardWeight * 9} ₽</p>`;
      } else {
        let rate = floor <= 5 ? 15 : floor <= 10 ? 20 : floor <= 20 ? 30 : 50;
        totalCost += standardWeight * rate;
        details += `<p>Обычный формат: выгрузка и подъём (этаж ${floor}): ${standardWeight} кг × ${rate} ₽ = ${standardWeight * rate} ₽</p>`;
      }
    }
  }

  return { cost: totalCost, details };
}

function calculateDelivery() {
  const data = window.formData;
  if (!data) return alert("Сначала сохраните параметры");

  const weight = (+data.weight_standard || 0) + (+data.weight_large || 0);
  const loadingType = data.loading_type;
  const distance = +data.deliveryDistance || 0;
  const extraKm = Math.max(0, distance - 40);

  let vehicle = selectVehicle(weight, loadingType);
  let note = "";

  // Паркинг < 2.2м — ограничение
  if (data.underground && parseFloat(data.height_limit || 0) < 2.2) {
    vehicle = selectVehicle(1500, loadingType);
    const trips = Math.ceil(weight / 1500);
    note = ` (ограничение высоты, ${trips} рейса на ${vehicle.name})`;
  }

  if (!vehicle) {
    document.getElementById("delivery_result").innerHTML = "<p style='color:red;'>Нет подходящего транспорта</p>";
    return;
  }

  let cost = vehicle.minTariff;
  cost += extraKm * vehicle.perKm;

  let surcharge = vehicle.surcharge?.[loadingType] || 0;
  cost += surcharge;

  if (data.return_pallets) {
    cost += 2500;
  }

  if (data.underground) {
    cost += 1500;
  }

  if (data.precise_time) {
    cost += 2500;
  }

  const deliveryHtml = `
    <h3>Доставка</h3>
    <p><strong>Транспорт:</strong> ${vehicle.name}${note}</p>
    <p><strong>Общий вес:</strong> ${weight} кг</p>
    <p><strong>Тип загрузки:</strong> ${loadingType}</p>
    <p><strong>Расстояние:</strong> ${distance.toFixed(2)} км</p>
    <p><strong>Базовый тариф:</strong> ${vehicle.minTariff.toLocaleString()} ₽</p>
    <p>Доп. км: ${extraKm.toFixed(2)} × ${vehicle.perKm} ₽ = ${(extraKm * vehicle.perKm).toLocaleString()} ₽</p>
    ${surcharge ? `<p>Надбавка за загрузку (${loadingType}): ${surcharge.toLocaleString()} ₽</p>` : ""}
    ${data.return_pallets ? "<p>Возврат тары: 2 500 ₽</p>" : ""}
    ${data.underground ? "<p>Подземный паркинг: 1 500 ₽</p>" : ""}
    ${data.precise_time ? "<p>Доставка к точному времени: 2 500 ₽</p>" : ""}
    <p><strong>Итого за доставку: ${Math.round(cost).toLocaleString()} ₽</strong></p>
  `;

  const { cost: moversCost, details: moversDetails } = calculateMoversCost(data);

  const moversHtml = moversCost
    ? `${moversDetails}<p><strong>Итого за грузчиков: ${moversCost.toLocaleString()} ₽</strong></p>`
    : "";

  document.getElementById("delivery_result").innerHTML = deliveryHtml;
  document.getElementById("movers_result").innerHTML = moversHtml;
}
